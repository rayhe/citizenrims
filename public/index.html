<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Crime Feed — Menlo Park, Atherton, Palo Alto & San Mateo County</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: system-ui, -apple-system, sans-serif; color: #1a1a1a; background: #e8eaed; }

  .page { max-width: 1100px; margin: 0 auto; background: #f5f6f8; min-height: 100vh; }

  header { background: linear-gradient(135deg, #1a1a2e 0%, #2d2d50 100%); color: #fff; padding: 18px 20px 14px; display: flex; align-items: baseline; gap: 16px; flex-wrap: wrap; }
  .header-left { flex: 1; min-width: 200px; }
  header h1 { font-size: 1.2rem; font-weight: 700; letter-spacing: -0.02em; }
  header p { color: #9a9ab0; margin-top: 2px; font-size: 0.78rem; line-height: 1.3; }
  .last-updated { color: #7a7a96; font-size: 0.72rem; white-space: nowrap; }

  .controls { display: flex; flex-wrap: wrap; gap: 0; background: #fff; border-bottom: 1px solid #eee; }
  .filter-bar { display: flex; gap: 5px; padding: 8px 14px; overflow-x: auto; -webkit-overflow-scrolling: touch; flex-wrap: nowrap; align-items: center; flex: 1; min-width: 0; }
  .filter-btn { font-size: 0.75rem; padding: 4px 12px; border-radius: 14px; border: 1px solid #ddd; background: #fff; cursor: pointer; white-space: nowrap; transition: all 0.15s ease; font-weight: 500; color: #555; }
  .filter-btn:hover { border-color: #aaa; }
  .filter-btn.active { background: #1a1a2e; color: #fff; border-color: #1a1a2e; }
  .filter-sep { width: 1px; height: 18px; background: #ddd; flex-shrink: 0; }
  .geo-btn { font-size: 0.7rem; padding: 3px 9px; border-radius: 12px; border: 1px solid #ddd; background: #fff; cursor: pointer; white-space: nowrap; transition: all 0.15s ease; font-weight: 600; color: #888; }
  .geo-btn:hover { border-color: #aaa; }
  .geo-btn.active { background: #00695c; color: #fff; border-color: #00695c; }
  .time-btn { font-size: 0.7rem; padding: 3px 9px; border-radius: 12px; border: 1px solid #ddd; background: #fff; cursor: pointer; white-space: nowrap; transition: all 0.15s ease; font-weight: 600; color: #888; }
  .time-btn:hover { border-color: #aaa; }
  .time-btn.active { background: #455a64; color: #fff; border-color: #455a64; }

  .legend { display: flex; gap: 10px; padding: 6px 14px; background: #fff; border-bottom: 1px solid #eee; font-size: 0.7rem; color: #666; overflow-x: auto; -webkit-overflow-scrolling: touch; flex-wrap: nowrap; align-items: center; }
  .legend span { display: flex; align-items: center; gap: 3px; white-space: nowrap; }
  .dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; flex-shrink: 0; }
  .legend-section { display: flex; gap: 8px; align-items: center; flex-shrink: 0; }
  .legend-divider { width: 1px; height: 14px; background: #ddd; flex-shrink: 0; }
  .crime-icon-demo { display: inline-flex; align-items: center; justify-content: center; border-radius: 50%; color: #fff; font-weight: 700; font-size: 10px; line-height: 1; flex-shrink: 0; }

  .main-area { display: flex; flex-direction: column; }
  .map-wrap { position: relative; flex-shrink: 0; }
  #map { width: 100%; height: 60vh; min-height: 360px; }
  .feed-toggle { position: absolute; bottom: 10px; right: 10px; z-index: 1000; background: #1a1a2e; color: #fff; border: none; padding: 6px 12px; border-radius: 14px; font: 600 0.75rem system-ui; cursor: pointer; box-shadow: 0 2px 6px rgba(0,0,0,0.3); transition: all 0.15s ease; }
  .feed-toggle:hover { background: #2d2d50; }
  .feed-toggle .feed-count { background: rgba(255,255,255,0.2); padding: 1px 6px; border-radius: 8px; margin-left: 5px; font-size: 0.68rem; }
  .feed-panel { background: #fff; border-top: 1px solid #ddd; height: 0; overflow: hidden; transition: height 0.2s ease; box-shadow: 0 2px 8px rgba(0,0,0,0.06); display: flex; flex-direction: column; }
  .feed-panel.feed-open { height: 220px; }
  .feed-panel.feed-dragging { transition: none; }
  .feed-header { display: flex; justify-content: space-between; align-items: center; padding: 4px 14px 5px; background: #fafafa; border-bottom: 1px solid #eee; flex-shrink: 0; }
  .feed-header-title { font-size: 0.78rem; font-weight: 600; color: #333; }
  .feed-header-close { font-size: 0.72rem; color: #999; cursor: pointer; }
  #feed-list { overflow-y: auto; flex: 1; -webkit-overflow-scrolling: touch; }
  .feed-drag { height: 18px; display: flex; align-items: center; justify-content: center; cursor: ns-resize; flex-shrink: 0; background: #fafafa; border-top: 1px solid #eee; touch-action: none; user-select: none; }
  .feed-drag-grip { width: 32px; height: 4px; border-radius: 2px; background: #ccc; }
  .feed-item { display: flex; align-items: center; gap: 10px; padding: 8px 14px; border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: background 0.1s; }
  .feed-item:hover, .feed-item.feed-highlight { background: #f5f7fa; }
  .feed-item.feed-highlight { box-shadow: inset 3px 0 0 #ff0; background: #fffde7; }
  .feed-icon { flex-shrink: 0; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #fff; font-weight: 700; font-size: 9px; }
  .feed-body { flex: 1; min-width: 0; }
  .feed-title { font-size: 0.8rem; font-weight: 600; color: #1a1a2e; }
  .feed-meta { font-size: 0.7rem; color: #999; }
  .feed-time { flex-shrink: 0; font-size: 0.68rem; color: #aaa; font-weight: 500; white-space: nowrap; }
  .feed-empty { padding: 18px; text-align: center; color: #bbb; font-size: 0.8rem; }

  .stats-bar { display: flex; gap: 10px; padding: 14px; background: #f5f6f8; }
  .stat { flex: 1; background: #fff; border-radius: 8px; padding: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); text-align: center; }
  .stat .num { font-size: 1.4rem; font-weight: 800; color: #1a1a2e; letter-spacing: -0.03em; }
  .stat .label { font-size: 0.68rem; color: #888; margin-top: 2px; text-transform: uppercase; letter-spacing: 0.03em; }

  .chart-section { padding: 14px; background: #f5f6f8; }
  .chart-wrap { background: #fff; border-radius: 8px; padding: 14px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
  .chart-wrap h2 { font-size: 0.82rem; margin: 0 0 8px; color: #444; font-weight: 600; }
  #timeline-chart { width: 100%; height: 140px; }

  .info-section { padding: 16px; background: #f5f6f8; }
  .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
  h2 { font-size: 0.92rem; margin: 0 0 8px; color: #444; font-weight: 600; }
  .agencies { list-style: none; }
  .agencies li { padding: 8px 0; border-bottom: 1px solid #eee; font-size: 0.82rem; }
  .agencies li:last-child { border: none; }
  .badge { display: inline-block; font-size: 0.62rem; padding: 2px 6px; border-radius: 4px; margin-left: 5px; vertical-align: middle; font-weight: 500; }
  .badge-inc { background: #e3f2fd; color: #1565c0; }
  .badge-case { background: #fce4ec; color: #c62828; }

  .endpoints { list-style: none; }
  .endpoints li { margin: 6px 0; }
  .endpoints a { color: #1a6dd4; text-decoration: none; font-size: 0.82rem; font-weight: 500; }
  .endpoints a:hover { text-decoration: underline; }
  .endpoints .desc { color: #999; font-size: 0.75rem; }

  pre { background: #1a1a2e; color: #a8d8a8; padding: 12px; border-radius: 8px; overflow-x: auto; font-size: 0.75rem; margin-top: 8px; -webkit-overflow-scrolling: touch; }

  footer { text-align: center; padding: 18px 14px; color: #aaa; font-size: 0.7rem; border-top: 1px solid #e0e0e0; }
  footer a { color: #888; }

  /* Modern popup */
  .leaflet-popup-content-wrapper { border-radius: 10px; box-shadow: 0 4px 16px rgba(0,0,0,0.15); padding: 0; }
  .leaflet-popup-content { margin: 0; font: 12px/1.5 system-ui, -apple-system, sans-serif; }
  .leaflet-popup-tip { box-shadow: 0 4px 16px rgba(0,0,0,0.15); }
  .popup-card { padding: 10px 12px; max-width: 280px; }
  .popup-card + .popup-card { border-top: 1px solid #eee; }
  .popup-type { display: flex; align-items: center; gap: 6px; margin-bottom: 4px; }
  .popup-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
  .popup-label { font-weight: 700; font-size: 0.82rem; color: #1a1a2e; }
  .popup-desc { color: #555; font-size: 0.78rem; }
  .popup-location { color: #888; font-size: 0.75rem; margin-top: 3px; }
  .popup-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 4px; font-size: 0.7rem; color: #aaa; }
  .popup-agency { font-style: italic; }
  .popup-scroll { overflow-y: auto; }

  /* Desktop: contained page */
  @media (min-width: 900px) {
    body { padding: 24px 0; }
    .page { border-radius: 12px; overflow: hidden; box-shadow: 0 2px 20px rgba(0,0,0,0.08); }
    #map { height: 58vh; }
  }

  /* Wide desktop: feed beside map */
  @media (min-width: 1200px) {
    .page { max-width: 1400px; }
    .main-area { flex-direction: row; }
    .map-wrap { flex: 2; min-width: 0; }
    .feed-toggle { display: none; }
    .feed-panel { flex: 1; min-width: 280px; max-width: 420px; height: auto !important; border-top: none; border-left: 1px solid #ddd; overflow: hidden; }
    .feed-panel, .feed-panel.feed-open { height: auto !important; }
    .feed-header-close { display: none; }
    .feed-drag { display: none; }
    #feed-list { max-height: 58vh; }
    #map { height: 58vh; }
  }

  /* Mobile: full-width, compact */
  @media (max-width: 600px) {
    body { padding: 0; background: #f5f6f8; }
    .page { border-radius: 0; box-shadow: none; }
    header { padding: 14px 12px 10px; flex-direction: column; gap: 4px; }
    header h1 { font-size: 1.1rem; }
    header p { font-size: 0.74rem; }
    #map { height: 50vh; min-height: 280px; }
    .stats-bar { gap: 6px; padding: 10px; }
    .stat { padding: 8px; }
    .stat .num { font-size: 1.2rem; }
    .stat .label { font-size: 0.62rem; }
    .info-grid { grid-template-columns: 1fr; gap: 12px; }
    .info-section { padding: 14px 12px; }
    .filter-bar { padding: 6px 10px; gap: 4px; }
    .legend { padding: 5px 10px; gap: 8px; }
  }
</style>
</head>
<body>
<div class="page">

<header>
  <div class="header-left">
    <h1>Crime Feed</h1>
    <p>Menlo Park, Atherton, Palo Alto &amp; SMC Sheriff — updated every 5 min</p>
  </div>
  <div class="last-updated" id="last-updated"></div>
</header>

<div class="controls">
  <div class="filter-bar">
    <button class="filter-btn active" data-filter="all">All</button>
    <button class="filter-btn" data-filter="incident">Incidents</button>
    <button class="filter-btn" data-filter="case">Cases</button>
    <button class="filter-btn" data-filter="violent">Violent</button>
    <button class="filter-btn" data-filter="property">Property</button>
    <button class="filter-btn" data-filter="alerts">Alerts</button>
    <span class="filter-sep"></span>
    <button class="filter-btn" data-filter="menlopark">Menlo Park</button>
    <button class="filter-btn" data-filter="atherton">Atherton</button>
    <button class="filter-btn" data-filter="paloalto">Palo Alto</button>
    <button class="filter-btn" data-filter="smcsheriff">SMC Sheriff</button>
    <span class="filter-sep"></span>
    <button class="geo-btn" id="geo-menlooaks">Menlo Oaks 3mi</button>
    <span class="filter-sep"></span>
    <button class="time-btn active" data-days="7">7d</button>
    <button class="time-btn" data-days="14">14d</button>
    <button class="time-btn" data-days="31">31d</button>
  </div>
</div>

<div class="legend">
  <div class="legend-section">
    <span><span class="dot" style="background:#4285f4"></span> MP inc.</span>
    <span><span class="dot" style="background:#ea4335"></span> MP case</span>
    <span><span class="dot" style="background:#34a853"></span> Ath inc.</span>
    <span><span class="dot" style="background:#ff6d00"></span> Ath case</span>
    <span><span class="dot" style="background:#00897b"></span> PA</span>
    <span><span class="dot" style="background:#9c27b0"></span> SMC</span>
  </div>
  <span class="legend-divider"></span>
  <div class="legend-section">
    <span><span class="crime-icon-demo" style="background:#d32f2f;width:14px;height:14px;font-size:10px">!</span> Violent</span>
    <span><span class="crime-icon-demo" style="background:#e65100;width:13px;height:13px;font-size:9px">$</span> Theft</span>
    <span><span class="crime-icon-demo" style="background:#1565c0;width:13px;height:13px;font-size:8px">&#x1F697;</span> Traffic</span>
    <span><span class="crime-icon-demo" style="background:#6a1b9a;width:13px;height:13px;font-size:8px">&#x1F48A;</span> Drugs</span>
    <span><span class="crime-icon-demo" style="background:#f9a825;width:12px;height:12px;font-size:8px">&#x1F441;</span> Suspicious</span>
    <span><span class="crime-icon-demo" style="background:#bf360c;width:12px;height:12px;font-size:8px">&#x1F525;</span> Fire</span>
    <span><span class="crime-icon-demo" style="background:#2e7d32;width:12px;height:12px;font-size:8px">+</span> Medical</span>
    <span><span class="crime-icon-demo" style="background:#757575;width:10px;height:10px;font-size:7px">&#x2022;</span> Other</span>
  </div>
  <span class="legend-divider"></span>
  <div class="legend-section" style="gap:8px">
    <span><span class="crime-icon-demo" style="background:#555;width:20px;height:20px;font-size:7px">&nbsp;</span> Crit</span>
    <span><span class="crime-icon-demo" style="background:#555;width:16px;height:16px;font-size:7px">&nbsp;</span> High</span>
    <span><span class="crime-icon-demo" style="background:#555;width:13px;height:13px;font-size:7px">&nbsp;</span> Med</span>
    <span><span class="crime-icon-demo" style="background:#555;width:10px;height:10px;font-size:7px">&nbsp;</span> Low</span>
  </div>
</div>

<div class="main-area">
  <div class="map-wrap">
    <div id="map"></div>
    <button class="feed-toggle" id="feed-toggle">Feed <span class="feed-count" id="feed-count">0</span></button>
  </div>
  <div class="feed-panel" id="feed-panel">
    <div class="feed-header" id="feed-header">
      <span class="feed-header-title">Latest in view</span>
      <span class="feed-header-close" id="feed-close">close</span>
    </div>
    <div id="feed-list"></div>
    <div class="feed-drag" id="feed-drag"><div class="feed-drag-grip"></div></div>
  </div>
</div>

<div class="stats-bar">
  <div class="stat"><div class="num" id="inc-count">—</div><div class="label" id="inc-label">Incidents (7d)</div></div>
  <div class="stat"><div class="num" id="case-count">—</div><div class="label">Crime Reports</div></div>
  <div class="stat"><div class="num" id="agency-count">4</div><div class="label">Agencies</div></div>
</div>

<div class="chart-section">
  <div class="chart-wrap">
    <h2 id="chart-title">Incidents per day</h2>
    <canvas id="timeline-chart"></canvas>
  </div>
</div>

<div class="info-section">
  <div class="info-grid">
    <div>
      <h2>Agencies</h2>
      <ul class="agencies">
        <li>Menlo Park PD <span class="badge badge-inc">incidents</span><span class="badge badge-case">cases</span></li>
        <li>Atherton PD <span class="badge badge-inc">incidents</span><span class="badge badge-case">cases</span></li>
        <li>Palo Alto PD <span class="badge badge-inc">incidents</span></li>
        <li>SMC Sheriff <span class="badge badge-case">cases only</span></li>
      </ul>
    </div>
    <div>
      <h2>JSON Endpoints</h2>
      <ul class="endpoints">
        <li><a href="feed.json">feed.json</a> <span class="desc">— All data</span></li>
        <li><a href="incidents.json">incidents.json</a> <span class="desc">— Incidents only</span></li>
        <li><a href="cases.json">cases.json</a> <span class="desc">— Cases only</span></li>
      </ul>
    </div>
  </div>
</div>

<footer>
  Data from <a href="https://citizenrims.com" style="color:#666">CitizenRIMS</a> and <a href="https://gis.cityofpaloalto.org" style="color:#666">Palo Alto GIS</a>.
  Auto-updated via GitHub Actions.
</footer>

</div><!-- .page -->

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/chart.js@4/dist/chart.umd.min.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script>
const COLORS = {
  menlopark:  { incident: '#4285f4', case: '#ea4335' },
  atherton:   { incident: '#34a853', case: '#ff6d00' },
  paloalto:   { incident: '#00897b', case: '#00897b' },
  smcsheriff: { incident: '#9c27b0', case: '#9c27b0' },
};

// severity → marker diameter in px
const SEVERITY = { critical: 24, high: 20, medium: 16, low: 12 };

// Each config: { icon, severity, iconColor }
// iconColor is the circle fill; the icon character is always white
const CRIME_CATEGORIES = [
  { icon: '!',      color: '#d32f2f', severity: 'critical',
    match: /assault|person crime|homicide|battery|robbery|weapon|stabbing|shooting|domestic/i },
  { icon: '$',      color: '#e65100', severity: 'high',
    match: /burglary|larceny|theft|fraud|stolen|shoplift|embezzle|forgery|identity/i },
  { icon: '\u{1F697}', color: '#1565c0', severity: 'medium',
    match: /traffic|collision|parking|hit.?and.?run|dui|reckless|vehicle stop|speed/i },
  { icon: '\u{1F48A}', color: '#6a1b9a', severity: 'high',
    match: /drug|narcotic|alcohol|controlled substance|paraphernalia/i },
  { icon: '\u{1F441}', color: '#f9a825', severity: 'medium',
    match: /suspicious|proactive|trespass|prowler|loiter/i },
  { icon: '\u{1F525}', color: '#bf360c', severity: 'medium',
    match: /fire|arson|hazard|hazmat/i },
  { icon: '+',      color: '#2e7d32', severity: 'low',
    match: /medical|welfare|mental health|ambulance|overdose/i },
  { icon: '!',      color: '#d32f2f', severity: 'critical',
    match: /weapon call|shots? fired/i },
  { icon: '$',      color: '#e65100', severity: 'high',
    match: /missing person/i },
];

const DEFAULT_CRIME = { icon: '\u{2022}', color: '#757575', severity: 'low' };
const SEVERITY_RANK = { critical: 3, high: 2, medium: 1, low: 0 };

const VIOLENT_RE = /assault|person crime|homicide|battery|robbery|weapon|stabbing|shooting|domestic|weapon call|shots? fired/i;
const PROPERTY_RE = /burglary|larceny|theft|fraud|stolen|shoplift|embezzle|forgery|identity|vandal|arson/i;
const ALERT_RE = /burglary|larceny|theft|fraud|stolen|shoplift|embezzle|forgery|identity|vandal|arson|suspicious\s*person|prowler|trespass/i;
const EXCLUDE_RE = /shoplift|petty.theft|484\s*theft|alarm.{0,5}burglary|burglary.{0,5}alarm/i;

const MENLO_OAKS_POLY = [
  [37.4717, -122.1680], // NW: Bay Rd & Ringwood Ave
  [37.4700, -122.1616], // NE: Bay Rd & Perimeter Rd
  [37.4629, -122.1651], // E:  Coleman Ave & Perimeter Rd
  [37.4636, -122.1673], // SE: Coleman Ave & Berkeley Ave
  [37.4599, -122.1706], // S:  South of Arlington Way
  [37.4611, -122.1732], // SW: Ringwood Ave & Arlington Way
];
const THREE_MILES_M = 4828;

function pointInPolygon(lat, lng, poly) {
  let inside = false;
  for (let i = 0, j = poly.length - 1; i < poly.length; j = i++) {
    const yi = poly[i][0], xi = poly[i][1];
    const yj = poly[j][0], xj = poly[j][1];
    if ((yi > lat) !== (yj > lat) && lng < (xj - xi) * (lat - yi) / (yj - yi) + xi) {
      inside = !inside;
    }
  }
  return inside;
}

function distanceToPolygonM(lat, lng, poly) {
  if (pointInPolygon(lat, lng, poly)) return 0;
  const pt = L.latLng(lat, lng);
  let minDist = Infinity;
  for (let i = 0; i < poly.length; i++) {
    const j = (i + 1) % poly.length;
    const a = poly[i], b = poly[j];
    const dx = b[0] - a[0], dy = b[1] - a[1];
    let t = dx === 0 && dy === 0 ? 0 : ((lat - a[0]) * dx + (lng - a[1]) * dy) / (dx * dx + dy * dy);
    t = Math.max(0, Math.min(1, t));
    const d = pt.distanceTo(L.latLng(a[0] + t * dx, a[1] + t * dy));
    if (d < minDist) minDist = d;
  }
  return minDist;
}

function classifyCrime(item) {
  const text = [
    item.callType, item.callTypeDescription,
    item.crimeType, item.crimeClassification,
    item.offenseDescription1
  ].filter(Boolean).join(' ');

  for (const cat of CRIME_CATEGORIES) {
    if (cat.match.test(text)) return cat;
  }
  return DEFAULT_CRIME;
}

function makeDivIcon(crimeConf, agencyColor) {
  const size = SEVERITY[crimeConf.severity];
  const fontSize = Math.max(size * 0.45, 8);
  // Ring color = agency color, fill = crime category color
  const html = `<div style="
    width:${size}px;height:${size}px;border-radius:50%;
    background:${crimeConf.color};
    border:2px solid ${agencyColor};
    display:flex;align-items:center;justify-content:center;
    color:#fff;font-weight:700;font-size:${fontSize}px;line-height:1;
    box-shadow:0 1px 4px rgba(0,0,0,0.3);
  ">${crimeConf.icon}</div>`;
  return L.divIcon({
    html,
    className: '',
    iconSize: [size, size],
    iconAnchor: [size / 2, size / 2],
    popupAnchor: [0, -size / 2],
  });
}

const map = L.map('map').setView([37.4665, -122.1663], 13);
L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
  attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="https://carto.com/">CARTO</a>',
  maxZoom: 20,
  subdomains: 'abcd',
}).addTo(map);

let allMarkers = [];
let lastRefreshDate = null;

// Persist settings in localStorage
function saveSettings() {
  localStorage.setItem('cf_settings', JSON.stringify({
    filter: activeFilter, days: activeDays, geo: geoMenloOaks,
  }));
  const p = new URLSearchParams();
  if (activeFilter !== 'all') p.set('filter', activeFilter);
  if (activeDays !== 7) p.set('days', activeDays);
  if (geoMenloOaks) p.set('geo', '1');
  const qs = p.toString();
  history.replaceState(null, '', qs ? '?' + qs : window.location.pathname);
}
const saved = (() => { try { return JSON.parse(localStorage.getItem('cf_settings')) || {}; } catch { return {}; } })();
const urlParams = new URLSearchParams(window.location.search);
let activeFilter = urlParams.get('filter') || saved.filter || 'all';
let activeDays = parseInt(urlParams.get('days')) || saved.days || 7;
let geoMenloOaks = urlParams.has('geo') ? urlParams.get('geo') === '1' : !!saved.geo;
const clusterGroup = L.markerClusterGroup({
  maxClusterRadius: 10,
  spiderfyOnMaxZoom: false,
  showCoverageOnHover: false,
  zoomToBoundsOnClick: false,
  iconCreateFunction: function(cluster) {
    const markers = cluster.getAllChildMarkers();
    const count = markers.length;
    let best = DEFAULT_CRIME;
    markers.forEach(m => {
      if (m._crimeConf && SEVERITY_RANK[m._crimeConf.severity] > SEVERITY_RANK[best.severity]) {
        best = m._crimeConf;
      }
    });
    const size = SEVERITY[best.severity] + 6;
    const fontSize = Math.max(size * 0.38, 8);
    return L.divIcon({
      html: `<div style="width:${size}px;height:${size}px;border-radius:50%;background:${best.color};color:#fff;display:flex;align-items:center;justify-content:center;font:bold ${fontSize}px system-ui;box-shadow:0 1px 4px rgba(0,0,0,0.4);border:2px solid #fff;position:relative"><span style="font-size:${fontSize * 0.7}px;position:absolute;top:-1px">${best.icon}</span><span style="font-size:${fontSize * 0.8}px;position:absolute;bottom:-1px">${count}</span></div>`,
      className: '',
      iconSize: [size, size],
      iconAnchor: [size / 2, size / 2],
    });
  },
});
const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;

function fmtDate(iso) {
  if (!iso) return '';
  const d = new Date(iso.endsWith('Z') ? iso : iso + 'Z');
  return isNaN(d) ? iso.split('T')[0] : d.toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' });
}

function popupCardHtml(item, crimeConf) {
  const source = item._source;
  const label = source === 'incident'
    ? (item.callType || item.callTypeDescription || 'Incident')
    : (item.crimeType || 'Case');
  const desc = source === 'incident'
    ? (item.callTypeDescription || '')
    : [item.offenseDescription1, item.crimeClassification ? `(${item.crimeClassification})` : ''].filter(Boolean).join(' ');
  const street = [item.street, item.city].filter(Boolean).join(', ');
  const dateStr = source === 'incident'
    ? [fmtDate(item.incidentDate), item.incidentTime].filter(Boolean).join(' ')
    : fmtDate(item.reportDate || item.occurrence1Date);
  const ago = (() => {
    const raw = item.incidentDate || item.reportDate || item.occurrence1Date;
    if (!raw) return '';
    const d = new Date(raw.endsWith('Z') ? raw : raw + 'Z');
    return isNaN(d) ? '' : timeAgo(d);
  })();
  return `<div class="popup-card">
    <div class="popup-type"><span class="popup-dot" style="background:${crimeConf.color}"></span><span class="popup-label">${label}</span></div>
    ${desc && desc !== label ? `<div class="popup-desc">${desc}</div>` : ''}
    ${street ? `<div class="popup-location">${street}</div>` : ''}
    <div class="popup-footer"><span>${dateStr}${ago ? ' · ' + ago : ''}</span><span class="popup-agency">${item._agency || ''}</span></div>
  </div>`;
}

function buildPopupCard(marker) {
  return popupCardHtml(marker._popupItem, marker._crimeConf);
}

function buildClusterPopup(cluster) {
  const markers = cluster.getAllChildMarkers();
  markers.sort((a, b) => (b._itemDate || 0) - (a._itemDate || 0));
  const cards = markers.map(m => popupCardHtml(m._popupItem, m._crimeConf)).join('');
  return `<div class="popup-scroll">${cards}</div>`;
}

// Smart popup positioning: avoids overflow off map edges
function smartPopup(latlng, content, opts) {
  const pt = map.latLngToContainerPoint(latlng);
  const mapSize = map.getSize();
  const pad = 60; // min distance from edge before flipping
  // Default: open above (negative Y offset)
  let offsetY = -12;
  let offsetX = 0;
  if (pt.y < mapSize.y * 0.35) {
    // Near top: open below
    offsetY = 16;
  }
  if (pt.x < pad + 140) {
    // Near left: shift right
    offsetX = 20;
  } else if (pt.x > mapSize.x - pad - 140) {
    // Near right: shift left
    offsetX = -20;
  }
  const popup = L.popup({
    maxWidth: 320, autoPan: false, closeButton: false,
    offset: [offsetX, offsetY],
    ...opts,
  })
    .setLatLng(latlng)
    .setContent(content)
    .openOn(map);
  return popup;
}

let clusterPopup = null;
clusterGroup.on('clusterclick', function(e) {
  if (isTouchDevice) {
    clusterPopup = smartPopup(e.layer.getLatLng(), buildClusterPopup(e.layer), { closeButton: true, autoPan: true });
  } else {
    e.layer.spiderfy();
  }
});
clusterGroup.on('clustermouseover', function(e) {
  if (isTouchDevice) return;
  clusterPopup = smartPopup(e.layer.getLatLng(), buildClusterPopup(e.layer));
});
clusterGroup.on('clustermouseout', function(e) {
  if (isTouchDevice) return;
  if (clusterPopup) { map.closePopup(clusterPopup); clusterPopup = null; }
});

function timeAgo(date) {
  const seconds = Math.floor((Date.now() - date.getTime()) / 1000);
  if (seconds < 60) return 'just now';
  const minutes = Math.floor(seconds / 60);
  if (minutes < 60) return `${minutes}m ago`;
  const hours = Math.floor(minutes / 60);
  if (hours < 24) return `${hours}h ${minutes % 60}m ago`;
  const days = Math.floor(hours / 24);
  return `${days}d ${hours % 24}h ago`;
}

function updateLastUpdated() {
  if (!lastRefreshDate) return;
  const el = document.getElementById('last-updated');
  const ts = lastRefreshDate.toLocaleString(undefined, {
    month: 'short', day: 'numeric', year: 'numeric',
    hour: 'numeric', minute: '2-digit', timeZoneName: 'short',
  });
  el.textContent = `Last updated: ${ts} (${timeAgo(lastRefreshDate)})`;
}

async function loadData() {
  const resp = await fetch('feed.json');
  const feedData = await resp.json();



  if (feedData.meta.generated_at) {
    const raw = feedData.meta.generated_at;
    lastRefreshDate = new Date(raw.match(/[Z+\-]\d/) ? raw : raw + 'Z');
    updateLastUpdated();
  }

  const items = [...feedData.incidents, ...feedData.cases];
  items.forEach(item => {
    if (!item.yCoord || !item.xCoord) return;
    const prefix = item._prefix;
    const source = item._source;
    const agencyColor = COLORS[prefix]?.[source] || '#999';
    const crimeConf = classifyCrime(item);

    const marker = L.marker([item.yCoord, item.xCoord], {
      icon: makeDivIcon(crimeConf, agencyColor),
    });

    marker._prefix = prefix;
    marker._source = source;
    marker._crimeConf = crimeConf;
    marker._crimeText = [item.callType, item.callTypeDescription, item.crimeType, item.crimeClassification, item.offenseDescription1].filter(Boolean).join(' ');
    const dateStr = item.incidentDate || item.reportDate || item.occurrence1Date || '';
    marker._itemDate = dateStr ? new Date(dateStr.endsWith('Z') ? dateStr : dateStr + 'Z') : null;
    const _title = source === 'incident' ? (item.callType || item.callTypeDescription || '') : (item.crimeType || item.offenseDescription1 || '');
    const _sub = source === 'incident'
      ? (item.callTypeDescription && item.callTypeDescription !== _title ? item.callTypeDescription : '')
      : (item.offenseDescription1 && item.offenseDescription1 !== _title ? item.offenseDescription1 : '');
    marker._itemData = {
      title: _title,
      subtitle: _sub,
      street: item.street || '',
      agency: item._agency || '',
    };
    marker._popupItem = item;

    let markerPopup = null;
    function openMarkerPopup(autoPan) {
      markerPopup = smartPopup(marker.getLatLng(), buildPopupCard(marker), autoPan ? { autoPan: true, closeButton: true } : {});
    }
    marker.on('click', function() {
      openMarkerPopup(true);
    });
    marker.on('mouseover', function() {
      if (!isTouchDevice) openMarkerPopup(false);
      if (!feedList._markerToEl) return;
      const el = feedList._markerToEl.get(marker);
      if (!el) return;
      el.classList.add('feed-highlight');
      el.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
    });
    marker.on('mouseout', function() {
      if (!isTouchDevice && markerPopup) { map.closePopup(markerPopup); markerPopup = null; }
      if (!feedList._markerToEl) return;
      const el = feedList._markerToEl.get(marker);
      if (el) el.classList.remove('feed-highlight');
    });
    allMarkers.push(marker);
  });
  map.addLayer(clusterGroup);
  applyFilters();
}

function applyFilters() {
  const cutoff = new Date(Date.now() - activeDays * 86400000);
  const toAdd = [];
  const toRemove = [];
  let visibleInc = 0, visibleCase = 0;
  allMarkers.forEach(m => {
    let show = true;
    // time filter
    if (m._itemDate && m._itemDate < cutoff) show = false;
    // type filter
    if (show && activeFilter !== 'all') {
      if (activeFilter === 'incident') show = m._source === 'incident';
      else if (activeFilter === 'case') show = m._source === 'case';
      else if (activeFilter === 'violent') show = VIOLENT_RE.test(m._crimeText);
      else if (activeFilter === 'property') show = PROPERTY_RE.test(m._crimeText);
      else if (activeFilter === 'alerts') show = ALERT_RE.test(m._crimeText) && !EXCLUDE_RE.test(m._crimeText);
      else if (activeFilter === 'menlopark' || activeFilter === 'atherton' || activeFilter === 'paloalto' || activeFilter === 'smcsheriff') show = m._prefix === activeFilter;
    }
    // geo filter (AND)
    if (show && geoMenloOaks) {
      show = distanceToPolygonM(m.getLatLng().lat, m.getLatLng().lng, MENLO_OAKS_POLY) <= THREE_MILES_M;
    }
    if (show) {
      toAdd.push(m);
      if (m._source === 'incident') visibleInc++; else visibleCase++;
    } else {
      toRemove.push(m);
    }
  });
  clusterGroup.removeLayers(toRemove);
  clusterGroup.addLayers(toAdd);
  visibleSet = new Set(toAdd);
  document.getElementById('inc-count').textContent = visibleInc.toLocaleString();
  document.getElementById('case-count').textContent = visibleCase.toLocaleString();
  document.getElementById('inc-label').textContent = `Incidents (${activeDays}d)`;
  if (typeof updateFeed === 'function') updateFeed();
  updateChart(toAdd);
}

let timelineChart = null;
function updateChart(markers) {
  const days = activeDays;
  const now = new Date();
  const buckets = {};
  for (let i = 0; i < days; i++) {
    const d = new Date(now);
    d.setDate(d.getDate() - i);
    buckets[d.toISOString().slice(0, 10)] = 0;
  }
  markers.forEach(m => {
    if (!m._itemDate) return;
    const key = m._itemDate.toISOString().slice(0, 10);
    if (key in buckets) buckets[key]++;
  });
  const sorted = Object.keys(buckets).sort();
  const labels = sorted.map(d => {
    const dt = new Date(d + 'T12:00:00');
    return dt.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
  });
  const data = sorted.map(d => buckets[d]);

  document.getElementById('chart-title').textContent = `Incidents per day (${days}d)`;

  if (timelineChart) {
    timelineChart.data.labels = labels;
    timelineChart.data.datasets[0].data = data;
    timelineChart.update('none');
    return;
  }
  const ctx = document.getElementById('timeline-chart').getContext('2d');
  timelineChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        data,
        backgroundColor: 'rgba(26,26,46,0.6)',
        borderRadius: 2,
      }],
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false }, tooltip: { callbacks: {
        title: items => items[0].label,
        label: item => `${item.raw} incident${item.raw !== 1 ? 's' : ''}`,
      }}},
      scales: {
        x: { grid: { display: false }, ticks: { font: { size: 10 }, maxRotation: 45, autoSkip: true, maxTicksLimit: days <= 14 ? days : 16 }},
        y: { beginAtZero: true, grid: { color: '#f0f0f0' }, ticks: { font: { size: 10 }, precision: 0 }},
      },
    },
  });
}

let moPolyLayer = null;
function toggleMenloOaksPoly() {
  if (geoMenloOaks && !moPolyLayer) {
    moPolyLayer = L.polygon(MENLO_OAKS_POLY, {
      color: '#004d40', weight: 3, opacity: 0.8, fillColor: '#00695c', fillOpacity: 0.06, dashArray: '6 4',
    }).addTo(map);
  } else if (!geoMenloOaks && moPolyLayer) {
    moPolyLayer.remove();
    moPolyLayer = null;
  }
}

// Restore active button states from saved settings
document.querySelectorAll('.filter-btn').forEach(b => {
  b.classList.toggle('active', b.dataset.filter === activeFilter);
});
document.querySelectorAll('.time-btn').forEach(b => {
  b.classList.toggle('active', parseInt(b.dataset.days) === activeDays);
});
document.getElementById('geo-menlooaks').classList.toggle('active', geoMenloOaks);
toggleMenloOaksPoly();

document.querySelector('.filter-bar').addEventListener('click', e => {
  if (e.target.classList.contains('filter-btn')) {
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    e.target.classList.add('active');
    activeFilter = e.target.dataset.filter;
    saveSettings();
    applyFilters();
  } else if (e.target.classList.contains('time-btn')) {
    document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
    e.target.classList.add('active');
    activeDays = parseInt(e.target.dataset.days);
    saveSettings();
    applyFilters();
  }
});

document.getElementById('geo-menlooaks').addEventListener('click', e => {
  geoMenloOaks = !geoMenloOaks;
  e.target.classList.toggle('active', geoMenloOaks);
  toggleMenloOaksPoly();
  saveSettings();
  applyFilters();
});

let feedOpen = false;
const feedPanel = document.getElementById('feed-panel');
const feedToggle = document.getElementById('feed-toggle');
const feedList = document.getElementById('feed-list');
const feedCountEl = document.getElementById('feed-count');

const feedDrag = document.getElementById('feed-drag');
const mapWrap = document.querySelector('.map-wrap');
const wideQuery = window.matchMedia('(min-width: 1200px)');
function isWide() { return wideQuery.matches; }

document.getElementById('feed-toggle').addEventListener('click', () => {
  if (isWide()) return; // sidebar always visible on wide
  feedOpen = !feedOpen;
  if (feedOpen) {
    feedPanel.style.height = '';
    feedPanel.classList.add('feed-open');
    updateFeed();
  } else {
    feedPanel.classList.remove('feed-open');
    feedPanel.style.height = '';
  }
});
document.getElementById('feed-close').addEventListener('click', (e) => {
  e.stopPropagation();
  feedOpen = false;
  feedPanel.classList.remove('feed-open');
  feedPanel.style.height = '';
});

// Drag bottom grip to resize — grip tracks cursor
let dragStartY = 0, dragStartH = 0;
function onDragMove(clientY) {
  const maxH = window.innerHeight * 0.7;
  const delta = clientY - dragStartY;
  const newH = Math.max(60, Math.min(maxH, dragStartH + delta));
  feedPanel.style.height = newH + 'px';
}
function onDragEnd() {
  feedPanel.classList.remove('feed-dragging');
  // Snap closed if too small
  if (feedPanel.offsetHeight < 100) {
    feedOpen = false;
    feedPanel.classList.remove('feed-open');
    feedPanel.style.height = '';
  }
}
feedDrag.addEventListener('mousedown', e => {
  e.preventDefault();
  dragStartY = e.clientY;
  dragStartH = feedPanel.offsetHeight;
  feedPanel.classList.add('feed-dragging');
  const onMove = ev => onDragMove(ev.clientY);
  const onUp = () => {
    onDragEnd();
    document.removeEventListener('mousemove', onMove);
    document.removeEventListener('mouseup', onUp);
  };
  document.addEventListener('mousemove', onMove);
  document.addEventListener('mouseup', onUp);
});
feedDrag.addEventListener('touchstart', e => {
  dragStartY = e.touches[0].clientY;
  dragStartH = feedPanel.offsetHeight;
  feedPanel.classList.add('feed-dragging');
  const onMove = ev => { ev.preventDefault(); onDragMove(ev.touches[0].clientY); };
  const onEnd = () => {
    onDragEnd();
    document.removeEventListener('touchmove', onMove);
    document.removeEventListener('touchend', onEnd);
  };
  document.addEventListener('touchmove', onMove, { passive: false });
  document.addEventListener('touchend', onEnd);
}, { passive: true });

// Track which markers are currently visible (pass filters)
let visibleSet = new Set();

function updateFeed() {
  const bounds = map.getBounds();
  const inView = [];
  visibleSet.forEach(m => {
    if (bounds.contains(m.getLatLng())) inView.push(m);
  });
  inView.sort((a, b) => (b._itemDate || 0) - (a._itemDate || 0));
  const capped = inView.slice(0, 50);
  feedCountEl.textContent = inView.length;

  if (!capped.length) {
    feedList.innerHTML = '<div class="feed-empty">No incidents in this area</div>';
    return;
  }

  feedList.innerHTML = capped.map((m, i) => {
    const d = m._itemData;
    const conf = m._crimeConf || DEFAULT_CRIME;
    const ago = m._itemDate ? timeAgo(m._itemDate) : '';
    return `<div class="feed-item" data-feed-idx="${i}">
      <span class="feed-icon" style="background:${conf.color}">${conf.icon}</span>
      <div class="feed-body">
        <div class="feed-title">${d.title}${d.subtitle ? ' <span style="font-weight:400;color:#777">· ' + d.subtitle + '</span>' : ''}</div>
        <div class="feed-meta">${d.street}${d.street && d.agency ? ' — ' : ''}${d.agency}</div>
      </div>
      <div class="feed-time">${ago}</div>
    </div>`;
  }).join('');

  // Store refs for click/hover handlers
  feedList._markers = capped;
  // Build reverse lookup: marker → feed DOM element
  feedList._markerToEl = new Map();
  capped.forEach((m, i) => {
    feedList._markerToEl.set(m, feedList.children[i]);
  });
}

let highlightCircle = null;
feedList.addEventListener('mouseover', e => {
  const item = e.target.closest('.feed-item');
  if (!item || !feedList._markers) return;
  const m = feedList._markers[parseInt(item.dataset.feedIdx)];
  if (!m) return;
  if (highlightCircle) { highlightCircle.remove(); }
  highlightCircle = L.circleMarker(m.getLatLng(), {
    radius: 22, weight: 3, color: '#ff0', fillColor: '#ff0', fillOpacity: 0.25, opacity: 0.9,
  }).addTo(map);
});
feedList.addEventListener('mouseout', e => {
  const related = e.relatedTarget;
  if (related && feedList.contains(related)) return;
  if (highlightCircle) { highlightCircle.remove(); highlightCircle = null; }
});

feedList.addEventListener('click', e => {
  const item = e.target.closest('.feed-item');
  if (!item || !feedList._markers) return;
  const idx = parseInt(item.dataset.feedIdx);
  const m = feedList._markers[idx];
  if (!m) return;
  if (highlightCircle) { highlightCircle.remove(); highlightCircle = null; }
  map.setView(m.getLatLng(), Math.max(map.getZoom(), 15));
  setTimeout(() => smartPopup(m.getLatLng(), buildPopupCard(m), { autoPan: false, closeButton: true }), 300);
});

// On wide screens, feed is always visible as sidebar
wideQuery.addEventListener('change', () => {
  if (isWide()) {
    feedOpen = true;
    feedPanel.classList.add('feed-open');
    feedPanel.style.height = '';
    updateFeed();
    map.invalidateSize();
  }
});

map.on('moveend', () => {
  if (feedOpen || isWide()) updateFeed();
  else {
    const bounds = map.getBounds();
    let count = 0;
    visibleSet.forEach(m => { if (bounds.contains(m.getLatLng())) count++; });
    feedCountEl.textContent = count;
  }
});

loadData().then(() => {
  if (isWide()) {
    feedOpen = true;
    feedPanel.classList.add('feed-open');
    updateFeed();
  }
});
setInterval(updateLastUpdated, 60000);
</script>

</body>
</html>

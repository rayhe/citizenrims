<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Crime Feed — Menlo Park, Atherton & San Mateo County</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: system-ui, -apple-system, sans-serif; color: #1a1a1a; background: #f8f8f8; }
  header { background: #1a1a2e; color: #fff; padding: 24px 20px; }
  header h1 { font-size: 1.4rem; font-weight: 600; }
  header p { color: #aab; margin-top: 6px; font-size: 0.9rem; }
  .last-updated { color: #8f8fa0; font-size: 0.78rem; margin-top: 8px; }
  #map { width: 100%; height: 55vh; min-height: 350px; }
  .content { max-width: 720px; margin: 0 auto; padding: 24px 20px; }
  .stats { display: flex; gap: 12px; margin-bottom: 24px; flex-wrap: wrap; }
  .stat { background: #fff; border-radius: 8px; padding: 16px; flex: 1; min-width: 140px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
  .stat .num { font-size: 1.8rem; font-weight: 700; color: #1a1a2e; }
  .stat .label { font-size: 0.8rem; color: #666; margin-top: 2px; }
  h2 { font-size: 1.1rem; margin: 20px 0 10px; color: #333; }
  .agencies { list-style: none; }
  .agencies li { padding: 8px 0; border-bottom: 1px solid #eee; font-size: 0.9rem; }
  .agencies li:last-child { border: none; }
  .badge { display: inline-block; font-size: 0.7rem; padding: 2px 6px; border-radius: 3px; margin-left: 6px; vertical-align: middle; }
  .badge-inc { background: #e3f2fd; color: #1565c0; }
  .badge-case { background: #fce4ec; color: #c62828; }
  .endpoints { list-style: none; }
  .endpoints li { margin: 6px 0; }
  .endpoints a { color: #0066cc; text-decoration: none; font-size: 0.9rem; }
  .endpoints a:hover { text-decoration: underline; }
  .endpoints .desc { color: #888; font-size: 0.8rem; }
  pre { background: #1a1a2e; color: #a8d8a8; padding: 14px; border-radius: 8px; overflow-x: auto; font-size: 0.82rem; margin-top: 8px; }
  footer { text-align: center; padding: 20px; color: #999; font-size: 0.75rem; }
  .legend { display: flex; gap: 16px; padding: 8px 20px; background: #fff; border-bottom: 1px solid #eee; font-size: 0.8rem; color: #555; flex-wrap: wrap; }
  .legend span { display: flex; align-items: center; gap: 4px; }
  .dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }
  .legend-section { display: flex; gap: 14px; align-items: center; flex-wrap: wrap; }
  .legend-divider { width: 1px; height: 16px; background: #ddd; }
  .crime-icon-demo { display: inline-flex; align-items: center; justify-content: center; border-radius: 50%; color: #fff; font-weight: 700; font-size: 10px; line-height: 1; }
  .filter-bar { display: flex; gap: 8px; padding: 10px 20px; background: #fff; border-bottom: 1px solid #eee; flex-wrap: wrap; }
  .filter-btn { font-size: 0.8rem; padding: 4px 12px; border-radius: 14px; border: 1px solid #ccc; background: #fff; cursor: pointer; }
  .filter-btn.active { background: #1a1a2e; color: #fff; border-color: #1a1a2e; }
</style>
</head>
<body>

<header>
  <h1>Crime Feed</h1>
  <p>Live incidents and crime reports from Menlo Park, Atherton, and San Mateo County Sheriff — updated every 5 minutes.</p>
  <div class="last-updated" id="last-updated"></div>
</header>

<div class="filter-bar">
  <button class="filter-btn active" data-filter="all">All</button>
  <button class="filter-btn" data-filter="incident">Incidents</button>
  <button class="filter-btn" data-filter="case">Cases</button>
  <button class="filter-btn" data-filter="menlopark">Menlo Park</button>
  <button class="filter-btn" data-filter="atherton">Atherton</button>
  <button class="filter-btn" data-filter="smcsheriff">SMC Sheriff</button>
</div>

<div class="legend">
  <div class="legend-section">
    <span><span class="dot" style="background:#4285f4"></span> Menlo Park inc.</span>
    <span><span class="dot" style="background:#ea4335"></span> Menlo Park cases</span>
    <span><span class="dot" style="background:#34a853"></span> Atherton inc.</span>
    <span><span class="dot" style="background:#ff6d00"></span> Atherton cases</span>
    <span><span class="dot" style="background:#9c27b0"></span> SMC Sheriff</span>
  </div>
  <span class="legend-divider"></span>
  <div class="legend-section">
    <span><span class="crime-icon-demo" style="background:#d32f2f;width:16px;height:16px;font-size:11px">!</span> Violent</span>
    <span><span class="crime-icon-demo" style="background:#e65100;width:14px;height:14px">$</span> Theft</span>
    <span><span class="crime-icon-demo" style="background:#1565c0;width:14px;height:14px;font-size:9px">&#x1F697;</span> Traffic</span>
    <span><span class="crime-icon-demo" style="background:#6a1b9a;width:14px;height:14px;font-size:9px">&#x1F48A;</span> Drugs</span>
    <span><span class="crime-icon-demo" style="background:#f9a825;width:12px;height:12px;font-size:8px">&#x1F441;</span> Suspicious</span>
    <span><span class="crime-icon-demo" style="background:#bf360c;width:12px;height:12px;font-size:8px">&#x1F525;</span> Fire</span>
    <span><span class="crime-icon-demo" style="background:#2e7d32;width:12px;height:12px;font-size:8px">+</span> Medical</span>
    <span><span class="crime-icon-demo" style="background:#757575;width:10px;height:10px;font-size:7px">&#x2022;</span> Other</span>
  </div>
  <span class="legend-divider"></span>
  <div class="legend-section" style="gap:10px">
    <span><span class="crime-icon-demo" style="background:#555;width:24px;height:24px;font-size:7px">&nbsp;</span> Critical</span>
    <span><span class="crime-icon-demo" style="background:#555;width:20px;height:20px;font-size:7px">&nbsp;</span> High</span>
    <span><span class="crime-icon-demo" style="background:#555;width:16px;height:16px;font-size:7px">&nbsp;</span> Med</span>
    <span><span class="crime-icon-demo" style="background:#555;width:12px;height:12px;font-size:7px">&nbsp;</span> Low</span>
  </div>
</div>

<div id="map"></div>

<div class="content">
  <div class="stats">
    <div class="stat"><div class="num" id="inc-count">—</div><div class="label">Incidents (7 days)</div></div>
    <div class="stat"><div class="num" id="case-count">—</div><div class="label">Crime Reports</div></div>
    <div class="stat"><div class="num" id="agency-count">3</div><div class="label">Agencies</div></div>
  </div>

  <h2>Agencies</h2>
  <ul class="agencies">
    <li>Menlo Park Police Department <span class="badge badge-inc">incidents</span><span class="badge badge-case">cases</span></li>
    <li>Atherton Police Department <span class="badge badge-inc">incidents</span><span class="badge badge-case">cases</span></li>
    <li>San Mateo County Sheriff's Office <span class="badge badge-case">cases only</span></li>
  </ul>

  <h2>JSON Endpoints</h2>
  <ul class="endpoints">
    <li><a href="feed.json">feed.json</a> <span class="desc">— All incidents + cases combined</span></li>
    <li><a href="incidents.json">incidents.json</a> <span class="desc">— Incidents only (calls for service)</span></li>
    <li><a href="cases.json">cases.json</a> <span class="desc">— Cases only (crime reports)</span></li>
  </ul>

  <h2>Fetch Example</h2>
  <pre>fetch('/feed.json')
  .then(r =&gt; r.json())
  .then(({ meta, incidents, cases }) =&gt; {
    console.log(`${meta.incident_count} incidents, ${meta.case_count} cases`)
    incidents.forEach(i =&gt;
      console.log(i.callType, i.street, i._agency))
  })</pre>
</div>

<footer>
  Data sourced from <a href="https://citizenrims.com" style="color:#666">CitizenRIMS</a> (Sun Ridge Systems).
  Auto-updated via GitHub Actions.
</footer>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script>
const COLORS = {
  menlopark:  { incident: '#4285f4', case: '#ea4335' },
  atherton:   { incident: '#34a853', case: '#ff6d00' },
  smcsheriff: { incident: '#9c27b0', case: '#9c27b0' },
};

// severity → marker diameter in px
const SEVERITY = { critical: 24, high: 20, medium: 16, low: 12 };

// Each config: { icon, severity, iconColor }
// iconColor is the circle fill; the icon character is always white
const CRIME_CATEGORIES = [
  { icon: '!',      color: '#d32f2f', severity: 'critical',
    match: /assault|person crime|homicide|battery|robbery|weapon|stabbing|shooting|domestic/i },
  { icon: '$',      color: '#e65100', severity: 'high',
    match: /burglary|larceny|theft|fraud|stolen|shoplift|embezzle|forgery|identity/i },
  { icon: '\u{1F697}', color: '#1565c0', severity: 'medium',
    match: /traffic|collision|parking|hit.?and.?run|dui|reckless|vehicle stop|speed/i },
  { icon: '\u{1F48A}', color: '#6a1b9a', severity: 'high',
    match: /drug|narcotic|alcohol|controlled substance|paraphernalia/i },
  { icon: '\u{1F441}', color: '#f9a825', severity: 'medium',
    match: /suspicious|proactive|trespass|prowler|loiter/i },
  { icon: '\u{1F525}', color: '#bf360c', severity: 'medium',
    match: /fire|arson|hazard|hazmat/i },
  { icon: '+',      color: '#2e7d32', severity: 'low',
    match: /medical|welfare|mental health|ambulance|overdose/i },
  { icon: '!',      color: '#d32f2f', severity: 'critical',
    match: /weapon call|shots? fired/i },
  { icon: '$',      color: '#e65100', severity: 'high',
    match: /missing person/i },
];

const DEFAULT_CRIME = { icon: '\u{2022}', color: '#757575', severity: 'low' };
const SEVERITY_RANK = { critical: 3, high: 2, medium: 1, low: 0 };

function classifyCrime(item) {
  const text = [
    item.callType, item.callTypeDescription,
    item.crimeType, item.crimeClassification,
    item.offenseDescription1
  ].filter(Boolean).join(' ');

  for (const cat of CRIME_CATEGORIES) {
    if (cat.match.test(text)) return cat;
  }
  return DEFAULT_CRIME;
}

function makeDivIcon(crimeConf, agencyColor) {
  const size = SEVERITY[crimeConf.severity];
  const fontSize = Math.max(size * 0.45, 8);
  // Ring color = agency color, fill = crime category color
  const html = `<div style="
    width:${size}px;height:${size}px;border-radius:50%;
    background:${crimeConf.color};
    border:2px solid ${agencyColor};
    display:flex;align-items:center;justify-content:center;
    color:#fff;font-weight:700;font-size:${fontSize}px;line-height:1;
    box-shadow:0 1px 4px rgba(0,0,0,0.3);
  ">${crimeConf.icon}</div>`;
  return L.divIcon({
    html,
    className: '',
    iconSize: [size, size],
    iconAnchor: [size / 2, size / 2],
    popupAnchor: [0, -size / 2],
  });
}

const map = L.map('map').setView([37.46, -122.18], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
  maxZoom: 19,
}).addTo(map);

let allMarkers = [];
let activeFilter = 'all';
let lastRefreshDate = null;
const clusterGroup = L.markerClusterGroup({
  maxClusterRadius: 10,
  spiderfyOnMaxZoom: false,
  showCoverageOnHover: false,
  zoomToBoundsOnClick: false,
  iconCreateFunction: function(cluster) {
    const markers = cluster.getAllChildMarkers();
    const count = markers.length;
    let best = DEFAULT_CRIME;
    markers.forEach(m => {
      if (m._crimeConf && SEVERITY_RANK[m._crimeConf.severity] > SEVERITY_RANK[best.severity]) {
        best = m._crimeConf;
      }
    });
    const size = SEVERITY[best.severity] + 6;
    const fontSize = Math.max(size * 0.38, 8);
    return L.divIcon({
      html: `<div style="width:${size}px;height:${size}px;border-radius:50%;background:${best.color};color:#fff;display:flex;align-items:center;justify-content:center;font:bold ${fontSize}px system-ui;box-shadow:0 1px 4px rgba(0,0,0,0.4);border:2px solid #fff;position:relative"><span style="font-size:${fontSize * 0.7}px;position:absolute;top:-1px">${best.icon}</span><span style="font-size:${fontSize * 0.8}px;position:absolute;bottom:-1px">${count}</span></div>`,
      className: '',
      iconSize: [size, size],
      iconAnchor: [size / 2, size / 2],
    });
  },
});
clusterGroup.on('clusterclick', function(e) {
  e.layer.spiderfy();
});

function timeAgo(date) {
  const seconds = Math.floor((Date.now() - date.getTime()) / 1000);
  if (seconds < 60) return 'just now';
  const minutes = Math.floor(seconds / 60);
  if (minutes < 60) return `${minutes}m ago`;
  const hours = Math.floor(minutes / 60);
  if (hours < 24) return `${hours}h ${minutes % 60}m ago`;
  const days = Math.floor(hours / 24);
  return `${days}d ${hours % 24}h ago`;
}

function updateLastUpdated() {
  if (!lastRefreshDate) return;
  const el = document.getElementById('last-updated');
  const ts = lastRefreshDate.toLocaleString();
  el.textContent = `Last updated: ${ts} (${timeAgo(lastRefreshDate)})`;
}

async function loadData() {
  const resp = await fetch('feed.json');
  const feedData = await resp.json();

  document.getElementById('inc-count').textContent = feedData.meta.incident_count.toLocaleString();
  document.getElementById('case-count').textContent = feedData.meta.case_count.toLocaleString();

  if (feedData.meta.generated_at) {
    lastRefreshDate = new Date(feedData.meta.generated_at);
    updateLastUpdated();
  }

  const items = [...feedData.incidents, ...feedData.cases];
  items.forEach(item => {
    if (!item.yCoord || !item.xCoord) return;
    const prefix = item._prefix;
    const source = item._source;
    const agencyColor = COLORS[prefix]?.[source] || '#999';
    const crimeConf = classifyCrime(item);

    const detail = source === 'incident'
      ? `<b>${item.callType || ''}</b><br>${item.callTypeDescription || ''}<br>${item.street || ''}, ${item.city || ''}<br>${(item.incidentDate || '').split('T')[0]} ${item.incidentTime || ''}<br><i style="color:#888">${item._agency}</i>`
      : `<b>${item.crimeType || ''}</b> (${item.crimeClassification || ''})<br>${item.offenseDescription1 || ''}<br>${item.street || ''}, ${item.city || ''}<br>${(item.reportDate || item.occurrence1Date || '').split('T')[0]}<br><i style="color:#888">${item._agency}</i>`;

    const marker = L.marker([item.yCoord, item.xCoord], {
      icon: makeDivIcon(crimeConf, agencyColor),
    });

    marker.bindPopup(`<div style="font:13px system-ui;max-width:260px">${detail}</div>`);
    marker._prefix = prefix;
    marker._source = source;
    marker._crimeConf = crimeConf;
    allMarkers.push(marker);
  });
  clusterGroup.addLayers(allMarkers);
  map.addLayer(clusterGroup);
}

function applyFilter(f) {
  activeFilter = f;
  const toAdd = [];
  const toRemove = [];
  allMarkers.forEach(m => {
    let show = f === 'all';
    if (f === 'incident') show = m._source === 'incident';
    else if (f === 'case') show = m._source === 'case';
    else if (f === 'menlopark' || f === 'atherton' || f === 'smcsheriff') show = m._prefix === f;
    else show = true;
    if (show) toAdd.push(m); else toRemove.push(m);
  });
  clusterGroup.removeLayers(toRemove);
  clusterGroup.addLayers(toAdd);
}

document.querySelector('.filter-bar').addEventListener('click', e => {
  if (!e.target.classList.contains('filter-btn')) return;
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
  e.target.classList.add('active');
  applyFilter(e.target.dataset.filter);
});

loadData();
setInterval(updateLastUpdated, 60000);
</script>

</body>
</html>

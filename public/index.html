<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Crime Feed — Menlo Park, Atherton, Palo Alto & San Mateo County</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: system-ui, -apple-system, sans-serif; color: #1a1a1a; background: #f5f6f8; }

  header { background: linear-gradient(135deg, #1a1a2e 0%, #2d2d50 100%); color: #fff; padding: 20px 20px 16px; }
  header h1 { font-size: 1.3rem; font-weight: 700; letter-spacing: -0.02em; }
  header p { color: #9a9ab0; margin-top: 4px; font-size: 0.82rem; line-height: 1.4; }
  .last-updated { color: #7a7a96; font-size: 0.72rem; margin-top: 6px; }

  #map { width: 100%; height: 55vh; min-height: 340px; }

  .content { max-width: 720px; margin: 0 auto; padding: 24px 16px; }
  .stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 24px; }
  .stat { background: #fff; border-radius: 10px; padding: 14px; box-shadow: 0 1px 3px rgba(0,0,0,0.06); }
  .stat .num { font-size: 1.6rem; font-weight: 800; color: #1a1a2e; letter-spacing: -0.03em; }
  .stat .label { font-size: 0.72rem; color: #888; margin-top: 2px; text-transform: uppercase; letter-spacing: 0.03em; }

  h2 { font-size: 1rem; margin: 24px 0 8px; color: #444; font-weight: 600; }
  .agencies { list-style: none; }
  .agencies li { padding: 10px 0; border-bottom: 1px solid #eee; font-size: 0.85rem; }
  .agencies li:last-child { border: none; }
  .badge { display: inline-block; font-size: 0.65rem; padding: 2px 7px; border-radius: 4px; margin-left: 6px; vertical-align: middle; font-weight: 500; }
  .badge-inc { background: #e3f2fd; color: #1565c0; }
  .badge-case { background: #fce4ec; color: #c62828; }

  .endpoints { list-style: none; }
  .endpoints li { margin: 8px 0; }
  .endpoints a { color: #1a6dd4; text-decoration: none; font-size: 0.85rem; font-weight: 500; }
  .endpoints a:hover { text-decoration: underline; }
  .endpoints .desc { color: #999; font-size: 0.78rem; }

  pre { background: #1a1a2e; color: #a8d8a8; padding: 14px; border-radius: 10px; overflow-x: auto; font-size: 0.78rem; margin-top: 8px; -webkit-overflow-scrolling: touch; }

  footer { text-align: center; padding: 24px 16px; color: #aaa; font-size: 0.72rem; }
  footer a { color: #888; }

  .filter-bar { display: flex; gap: 6px; padding: 10px 16px; background: #fff; border-bottom: 1px solid #eee; overflow-x: auto; -webkit-overflow-scrolling: touch; flex-wrap: nowrap; align-items: center; }
  .filter-btn { font-size: 0.78rem; padding: 5px 14px; border-radius: 16px; border: 1px solid #ddd; background: #fff; cursor: pointer; white-space: nowrap; transition: all 0.15s ease; font-weight: 500; color: #555; }
  .filter-btn:hover { border-color: #aaa; }
  .filter-btn.active { background: #1a1a2e; color: #fff; border-color: #1a1a2e; }
  .filter-sep { width: 1px; height: 20px; background: #ddd; flex-shrink: 0; }
  .time-btn { font-size: 0.72rem; padding: 4px 10px; border-radius: 12px; border: 1px solid #ddd; background: #fff; cursor: pointer; white-space: nowrap; transition: all 0.15s ease; font-weight: 600; color: #888; }
  .time-btn:hover { border-color: #aaa; }
  .time-btn.active { background: #455a64; color: #fff; border-color: #455a64; }

  .legend { display: flex; gap: 12px; padding: 8px 16px; background: #fff; border-bottom: 1px solid #eee; font-size: 0.75rem; color: #666; overflow-x: auto; -webkit-overflow-scrolling: touch; flex-wrap: nowrap; align-items: center; }
  .legend span { display: flex; align-items: center; gap: 4px; white-space: nowrap; }
  .dot { width: 9px; height: 9px; border-radius: 50%; display: inline-block; flex-shrink: 0; }
  .legend-section { display: flex; gap: 10px; align-items: center; flex-shrink: 0; }
  .legend-divider { width: 1px; height: 16px; background: #ddd; flex-shrink: 0; }
  .crime-icon-demo { display: inline-flex; align-items: center; justify-content: center; border-radius: 50%; color: #fff; font-weight: 700; font-size: 10px; line-height: 1; flex-shrink: 0; }

  @media (max-width: 600px) {
    header { padding: 16px 14px 12px; }
    header h1 { font-size: 1.15rem; }
    header p { font-size: 0.76rem; }
    #map { height: 50vh; min-height: 280px; }
    .stats { grid-template-columns: repeat(3, 1fr); gap: 8px; }
    .stat { padding: 10px; }
    .stat .num { font-size: 1.3rem; }
    .stat .label { font-size: 0.65rem; }
    .content { padding: 16px 14px; }
    .filter-bar { padding: 8px 14px; gap: 6px; }
    .legend { padding: 6px 14px; gap: 10px; }
  }
</style>
</head>
<body>

<header>
  <h1>Crime Feed</h1>
  <p>Live incidents and crime reports from Menlo Park, Atherton, Palo Alto, and San Mateo County Sheriff — updated every 5 minutes.</p>
  <div class="last-updated" id="last-updated"></div>
</header>

<div class="filter-bar">
  <button class="filter-btn active" data-filter="all">All</button>
  <button class="filter-btn" data-filter="incident">Incidents</button>
  <button class="filter-btn" data-filter="case">Cases</button>
  <button class="filter-btn" data-filter="violent">Violent</button>
  <button class="filter-btn" data-filter="property">Property</button>
  <span class="filter-sep"></span>
  <button class="filter-btn" data-filter="menlopark">Menlo Park</button>
  <button class="filter-btn" data-filter="atherton">Atherton</button>
  <button class="filter-btn" data-filter="paloalto">Palo Alto</button>
  <button class="filter-btn" data-filter="smcsheriff">SMC Sheriff</button>
  <span class="filter-sep"></span>
  <button class="time-btn active" data-days="7">7d</button>
  <button class="time-btn" data-days="14">14d</button>
  <button class="time-btn" data-days="31">31d</button>
</div>

<div class="legend">
  <div class="legend-section">
    <span><span class="dot" style="background:#4285f4"></span> Menlo Park inc.</span>
    <span><span class="dot" style="background:#ea4335"></span> Menlo Park cases</span>
    <span><span class="dot" style="background:#34a853"></span> Atherton inc.</span>
    <span><span class="dot" style="background:#ff6d00"></span> Atherton cases</span>
    <span><span class="dot" style="background:#00897b"></span> Palo Alto</span>
    <span><span class="dot" style="background:#9c27b0"></span> SMC Sheriff</span>
  </div>
  <span class="legend-divider"></span>
  <div class="legend-section">
    <span><span class="crime-icon-demo" style="background:#d32f2f;width:16px;height:16px;font-size:11px">!</span> Violent</span>
    <span><span class="crime-icon-demo" style="background:#e65100;width:14px;height:14px">$</span> Theft</span>
    <span><span class="crime-icon-demo" style="background:#1565c0;width:14px;height:14px;font-size:9px">&#x1F697;</span> Traffic</span>
    <span><span class="crime-icon-demo" style="background:#6a1b9a;width:14px;height:14px;font-size:9px">&#x1F48A;</span> Drugs</span>
    <span><span class="crime-icon-demo" style="background:#f9a825;width:12px;height:12px;font-size:8px">&#x1F441;</span> Suspicious</span>
    <span><span class="crime-icon-demo" style="background:#bf360c;width:12px;height:12px;font-size:8px">&#x1F525;</span> Fire</span>
    <span><span class="crime-icon-demo" style="background:#2e7d32;width:12px;height:12px;font-size:8px">+</span> Medical</span>
    <span><span class="crime-icon-demo" style="background:#757575;width:10px;height:10px;font-size:7px">&#x2022;</span> Other</span>
  </div>
  <span class="legend-divider"></span>
  <div class="legend-section" style="gap:10px">
    <span><span class="crime-icon-demo" style="background:#555;width:24px;height:24px;font-size:7px">&nbsp;</span> Critical</span>
    <span><span class="crime-icon-demo" style="background:#555;width:20px;height:20px;font-size:7px">&nbsp;</span> High</span>
    <span><span class="crime-icon-demo" style="background:#555;width:16px;height:16px;font-size:7px">&nbsp;</span> Med</span>
    <span><span class="crime-icon-demo" style="background:#555;width:12px;height:12px;font-size:7px">&nbsp;</span> Low</span>
  </div>
</div>

<div id="map"></div>

<div class="content">
  <div class="stats">
    <div class="stat"><div class="num" id="inc-count">—</div><div class="label" id="inc-label">Incidents (7d)</div></div>
    <div class="stat"><div class="num" id="case-count">—</div><div class="label">Crime Reports</div></div>
    <div class="stat"><div class="num" id="agency-count">4</div><div class="label">Agencies</div></div>
  </div>

  <h2>Agencies</h2>
  <ul class="agencies">
    <li>Menlo Park Police Department <span class="badge badge-inc">incidents</span><span class="badge badge-case">cases</span></li>
    <li>Atherton Police Department <span class="badge badge-inc">incidents</span><span class="badge badge-case">cases</span></li>
    <li>Palo Alto Police Department <span class="badge badge-inc">incidents</span></li>
    <li>San Mateo County Sheriff's Office <span class="badge badge-case">cases only</span></li>
  </ul>

  <h2>JSON Endpoints</h2>
  <ul class="endpoints">
    <li><a href="feed.json">feed.json</a> <span class="desc">— All incidents + cases combined</span></li>
    <li><a href="incidents.json">incidents.json</a> <span class="desc">— Incidents only (calls for service)</span></li>
    <li><a href="cases.json">cases.json</a> <span class="desc">— Cases only (crime reports)</span></li>
  </ul>

  <h2>Fetch Example</h2>
  <pre>fetch('/feed.json')
  .then(r =&gt; r.json())
  .then(({ meta, incidents, cases }) =&gt; {
    console.log(`${meta.incident_count} incidents, ${meta.case_count} cases`)
    incidents.forEach(i =&gt;
      console.log(i.callType, i.street, i._agency))
  })</pre>
</div>

<footer>
  Data sourced from <a href="https://citizenrims.com" style="color:#666">CitizenRIMS</a> (Sun Ridge Systems) and <a href="https://gis.cityofpaloalto.org" style="color:#666">City of Palo Alto GIS</a>.
  Auto-updated via GitHub Actions.
</footer>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script>
const COLORS = {
  menlopark:  { incident: '#4285f4', case: '#ea4335' },
  atherton:   { incident: '#34a853', case: '#ff6d00' },
  paloalto:   { incident: '#00897b', case: '#00897b' },
  smcsheriff: { incident: '#9c27b0', case: '#9c27b0' },
};

// severity → marker diameter in px
const SEVERITY = { critical: 24, high: 20, medium: 16, low: 12 };

// Each config: { icon, severity, iconColor }
// iconColor is the circle fill; the icon character is always white
const CRIME_CATEGORIES = [
  { icon: '!',      color: '#d32f2f', severity: 'critical',
    match: /assault|person crime|homicide|battery|robbery|weapon|stabbing|shooting|domestic/i },
  { icon: '$',      color: '#e65100', severity: 'high',
    match: /burglary|larceny|theft|fraud|stolen|shoplift|embezzle|forgery|identity/i },
  { icon: '\u{1F697}', color: '#1565c0', severity: 'medium',
    match: /traffic|collision|parking|hit.?and.?run|dui|reckless|vehicle stop|speed/i },
  { icon: '\u{1F48A}', color: '#6a1b9a', severity: 'high',
    match: /drug|narcotic|alcohol|controlled substance|paraphernalia/i },
  { icon: '\u{1F441}', color: '#f9a825', severity: 'medium',
    match: /suspicious|proactive|trespass|prowler|loiter/i },
  { icon: '\u{1F525}', color: '#bf360c', severity: 'medium',
    match: /fire|arson|hazard|hazmat/i },
  { icon: '+',      color: '#2e7d32', severity: 'low',
    match: /medical|welfare|mental health|ambulance|overdose/i },
  { icon: '!',      color: '#d32f2f', severity: 'critical',
    match: /weapon call|shots? fired/i },
  { icon: '$',      color: '#e65100', severity: 'high',
    match: /missing person/i },
];

const DEFAULT_CRIME = { icon: '\u{2022}', color: '#757575', severity: 'low' };
const SEVERITY_RANK = { critical: 3, high: 2, medium: 1, low: 0 };

const VIOLENT_RE = /assault|person crime|homicide|battery|robbery|weapon|stabbing|shooting|domestic|weapon call|shots? fired/i;
const PROPERTY_RE = /burglary|larceny|theft|fraud|stolen|shoplift|embezzle|forgery|identity|vandal|arson/i;

function classifyCrime(item) {
  const text = [
    item.callType, item.callTypeDescription,
    item.crimeType, item.crimeClassification,
    item.offenseDescription1
  ].filter(Boolean).join(' ');

  for (const cat of CRIME_CATEGORIES) {
    if (cat.match.test(text)) return cat;
  }
  return DEFAULT_CRIME;
}

function makeDivIcon(crimeConf, agencyColor) {
  const size = SEVERITY[crimeConf.severity];
  const fontSize = Math.max(size * 0.45, 8);
  // Ring color = agency color, fill = crime category color
  const html = `<div style="
    width:${size}px;height:${size}px;border-radius:50%;
    background:${crimeConf.color};
    border:2px solid ${agencyColor};
    display:flex;align-items:center;justify-content:center;
    color:#fff;font-weight:700;font-size:${fontSize}px;line-height:1;
    box-shadow:0 1px 4px rgba(0,0,0,0.3);
  ">${crimeConf.icon}</div>`;
  return L.divIcon({
    html,
    className: '',
    iconSize: [size, size],
    iconAnchor: [size / 2, size / 2],
    popupAnchor: [0, -size / 2],
  });
}

const map = L.map('map').setView([37.44, -122.16], 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
  maxZoom: 19,
}).addTo(map);

let allMarkers = [];
let activeFilter = 'all';
let activeDays = 7;
let lastRefreshDate = null;
const clusterGroup = L.markerClusterGroup({
  maxClusterRadius: 10,
  spiderfyOnMaxZoom: false,
  showCoverageOnHover: false,
  zoomToBoundsOnClick: false,
  iconCreateFunction: function(cluster) {
    const markers = cluster.getAllChildMarkers();
    const count = markers.length;
    let best = DEFAULT_CRIME;
    markers.forEach(m => {
      if (m._crimeConf && SEVERITY_RANK[m._crimeConf.severity] > SEVERITY_RANK[best.severity]) {
        best = m._crimeConf;
      }
    });
    const size = SEVERITY[best.severity] + 6;
    const fontSize = Math.max(size * 0.38, 8);
    return L.divIcon({
      html: `<div style="width:${size}px;height:${size}px;border-radius:50%;background:${best.color};color:#fff;display:flex;align-items:center;justify-content:center;font:bold ${fontSize}px system-ui;box-shadow:0 1px 4px rgba(0,0,0,0.4);border:2px solid #fff;position:relative"><span style="font-size:${fontSize * 0.7}px;position:absolute;top:-1px">${best.icon}</span><span style="font-size:${fontSize * 0.8}px;position:absolute;bottom:-1px">${count}</span></div>`,
      className: '',
      iconSize: [size, size],
      iconAnchor: [size / 2, size / 2],
    });
  },
});
clusterGroup.on('clusterclick', function(e) {
  e.layer.spiderfy();
});

function timeAgo(date) {
  const seconds = Math.floor((Date.now() - date.getTime()) / 1000);
  if (seconds < 60) return 'just now';
  const minutes = Math.floor(seconds / 60);
  if (minutes < 60) return `${minutes}m ago`;
  const hours = Math.floor(minutes / 60);
  if (hours < 24) return `${hours}h ${minutes % 60}m ago`;
  const days = Math.floor(hours / 24);
  return `${days}d ${hours % 24}h ago`;
}

function updateLastUpdated() {
  if (!lastRefreshDate) return;
  const el = document.getElementById('last-updated');
  const ts = lastRefreshDate.toLocaleString(undefined, {
    month: 'short', day: 'numeric', year: 'numeric',
    hour: 'numeric', minute: '2-digit', timeZoneName: 'short',
  });
  el.textContent = `Last updated: ${ts} (${timeAgo(lastRefreshDate)})`;
}

async function loadData() {
  const resp = await fetch('feed.json');
  const feedData = await resp.json();



  if (feedData.meta.generated_at) {
    const raw = feedData.meta.generated_at;
    lastRefreshDate = new Date(raw.match(/[Z+\-]\d/) ? raw : raw + 'Z');
    updateLastUpdated();
  }

  const items = [...feedData.incidents, ...feedData.cases];
  items.forEach(item => {
    if (!item.yCoord || !item.xCoord) return;
    const prefix = item._prefix;
    const source = item._source;
    const agencyColor = COLORS[prefix]?.[source] || '#999';
    const crimeConf = classifyCrime(item);

    const fmtDate = (iso) => {
      if (!iso) return '';
      const d = new Date(iso.endsWith('Z') ? iso : iso + 'Z');
      return isNaN(d) ? iso.split('T')[0] : d.toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' });
    };

    const detail = source === 'incident'
      ? `<b>${item.callType || ''}</b><br>${item.callTypeDescription || ''}<br>${item.street || ''}, ${item.city || ''}<br>${fmtDate(item.incidentDate)} ${item.incidentTime || ''}<br><i style="color:#888">${item._agency}</i>`
      : `<b>${item.crimeType || ''}</b> (${item.crimeClassification || ''})<br>${item.offenseDescription1 || ''}<br>${item.street || ''}, ${item.city || ''}<br>${fmtDate(item.reportDate || item.occurrence1Date)}<br><i style="color:#888">${item._agency}</i>`;

    const marker = L.marker([item.yCoord, item.xCoord], {
      icon: makeDivIcon(crimeConf, agencyColor),
    });

    marker.bindPopup(`<div style="font:13px system-ui;max-width:260px">${detail}</div>`);
    marker._prefix = prefix;
    marker._source = source;
    marker._crimeConf = crimeConf;
    marker._crimeText = [item.callType, item.callTypeDescription, item.crimeType, item.crimeClassification, item.offenseDescription1].filter(Boolean).join(' ');
    const dateStr = item.incidentDate || item.reportDate || item.occurrence1Date || '';
    marker._itemDate = dateStr ? new Date(dateStr.endsWith('Z') ? dateStr : dateStr + 'Z') : null;
    allMarkers.push(marker);
  });
  map.addLayer(clusterGroup);
  applyFilters();
}

function applyFilters() {
  const cutoff = new Date(Date.now() - activeDays * 86400000);
  const toAdd = [];
  const toRemove = [];
  let visibleInc = 0, visibleCase = 0;
  allMarkers.forEach(m => {
    let show = true;
    // time filter
    if (m._itemDate && m._itemDate < cutoff) show = false;
    // type filter
    if (show && activeFilter !== 'all') {
      if (activeFilter === 'incident') show = m._source === 'incident';
      else if (activeFilter === 'case') show = m._source === 'case';
      else if (activeFilter === 'violent') show = VIOLENT_RE.test(m._crimeText);
      else if (activeFilter === 'property') show = PROPERTY_RE.test(m._crimeText);
      else if (activeFilter === 'menlopark' || activeFilter === 'atherton' || activeFilter === 'paloalto' || activeFilter === 'smcsheriff') show = m._prefix === activeFilter;
    }
    if (show) {
      toAdd.push(m);
      if (m._source === 'incident') visibleInc++; else visibleCase++;
    } else {
      toRemove.push(m);
    }
  });
  clusterGroup.removeLayers(toRemove);
  clusterGroup.addLayers(toAdd);
  document.getElementById('inc-count').textContent = visibleInc.toLocaleString();
  document.getElementById('case-count').textContent = visibleCase.toLocaleString();
  document.getElementById('inc-label').textContent = `Incidents (${activeDays}d)`;
}

document.querySelector('.filter-bar').addEventListener('click', e => {
  if (e.target.classList.contains('filter-btn')) {
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    e.target.classList.add('active');
    activeFilter = e.target.dataset.filter;
    applyFilters();
  } else if (e.target.classList.contains('time-btn')) {
    document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
    e.target.classList.add('active');
    activeDays = parseInt(e.target.dataset.days);
    applyFilters();
  }
});

loadData();
setInterval(updateLastUpdated, 60000);
</script>

</body>
</html>
